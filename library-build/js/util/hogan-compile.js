/*!
 *  Copyright 2011 Twitter, Inc.
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */

define(["exports"],function(Hogan){function cleanTripleStache(token){token.n.substr(token.n.length-1)==="}"&&(token.n=token.n.substring(0,token.n.length-1))}function trim(s){return s.trim?s.trim():s.replace(/^\s*|\s*$/g,"")}function tagChange(tag,text,index){if(text.charAt(index)!=tag.charAt(0))return!1;for(var i=1,l=tag.length;i<l;i++)if(text.charAt(index+i)!=tag.charAt(i))return!1;return!0}function buildTree(tokens,kind,stack,customTags){var instructions=[],opener=null,token=null;while(tokens.length>0){token=tokens.shift();if(token.tag=="#"||token.tag=="^"||isOpener(token,customTags))stack.push(token),token.nodes=buildTree(tokens,token.tag,stack,customTags),instructions.push(token);else{if(token.tag=="/"){if(stack.length===0)throw new Error("Closing tag without opener: /"+token.n);opener=stack.pop();if(token.n!=opener.n&&!isCloser(token.n,opener.n,customTags))throw new Error("Nesting error: "+opener.n+" vs. "+token.n);return opener.end=token.i,instructions}instructions.push(token)}}if(stack.length>0)throw new Error("missing closing tag: "+stack.pop().n);return instructions}function isOpener(token,tags){for(var i=0,l=tags.length;i<l;i++)if(tags[i].o==token.n)return token.tag="#",!0}function isCloser(close,open,tags){for(var i=0,l=tags.length;i<l;i++)if(tags[i].c==close&&tags[i].o==open)return!0}function esc(s){return s.replace(rSlash,"\\\\").replace(rQuot,'\\"').replace(rNewline,"\\n").replace(rCr,"\\r")}function chooseMethod(s){return~s.indexOf(".")?"d":"f"}function walk(tree){var code="";for(var i=0,l=tree.length;i<l;i++){var tag=tree[i].tag;tag=="#"?code+=section(tree[i].nodes,tree[i].n,chooseMethod(tree[i].n),tree[i].i,tree[i].end,tree[i].otag+" "+tree[i].ctag):tag=="^"?code+=invertedSection(tree[i].nodes,tree[i].n,chooseMethod(tree[i].n)):tag=="<"||tag==">"?code+=partial(tree[i]):tag=="{"||tag=="&"?code+=tripleStache(tree[i].n,chooseMethod(tree[i].n)):tag=="\n"?code+=text('"\\n"'+(tree.length-1==i?"":" + i")):tag=="_v"?code+=variable(tree[i].n,chooseMethod(tree[i].n)):tag===undefined&&(code+=text('"'+esc(tree[i])+'"'))}return code}function section(nodes,id,method,start,end,tags){return"if(_.s(_."+method+'("'+esc(id)+'",c,p,1),'+"c,p,0,"+start+","+end+',"'+tags+'")){'+"_.rs(c,p,"+"function(c,p,_){"+walk(nodes)+"});c.pop();}"}function invertedSection(nodes,id,method){return"if(!_.s(_."+method+'("'+esc(id)+'",c,p,1),c,p,1,0,0,"")){'+walk(nodes)+"};"}function partial(tok){return'_.b(_.rp("'+esc(tok.n)+'",c,p,"'+(tok.indent||"")+'"));'}function tripleStache(id,method){return"_.b(_.t(_."+method+'("'+esc(id)+'",c,p,0)));'}function variable(id,method){return"_.b(_.v(_."+method+'("'+esc(id)+'",c,p,0)));'}function text(id){return"_.b("+id+");"}var rIsWhitespace=/\S/,rQuot=/\"/g,rNewline=/\n/g,rCr=/\r/g,rSlash=/\\/g,tagTypes={"#":1,"^":2,"/":3,"!":4,">":5,"<":6,"=":7,_v:8,"{":9,"&":10};Hogan.scan=function(text,delimiters){function addBuf(){buf.length>0&&(tokens.push(new String(buf)),buf="")}function lineIsWhitespace(){var isAllWhitespace=!0;for(var j=lineStart;j<tokens.length;j++){isAllWhitespace=tokens[j].tag&&tagTypes[tokens[j].tag]<tagTypes._v||!tokens[j].tag&&tokens[j].match(rIsWhitespace)===null;if(!isAllWhitespace)return!1}return isAllWhitespace}function filterLine(haveSeenTag,noNewLine){addBuf();if(haveSeenTag&&lineIsWhitespace())for(var j=lineStart,next;j<tokens.length;j++)tokens[j].tag||((next=tokens[j+1])&&next.tag==">"&&(next.indent=tokens[j].toString()),tokens.splice(j,1));else noNewLine||tokens.push({tag:"\n"});seenTag=!1,lineStart=tokens.length}function changeDelimiters(text,index){var close="="+ctag,closeIndex=text.indexOf(close,index),delimiters=trim(text.substring(text.indexOf("=",index)+1,closeIndex)).split(" ");return otag=delimiters[0],ctag=delimiters[1],closeIndex+close.length-1}var len=text.length,IN_TEXT=0,IN_TAG_TYPE=1,IN_TAG=2,state=IN_TEXT,tagType=null,tag=null,buf="",tokens=[],seenTag=!1,i=0,lineStart=0,otag="{{",ctag="}}";delimiters&&(delimiters=delimiters.split(" "),otag=delimiters[0],ctag=delimiters[1]);for(i=0;i<len;i++)state==IN_TEXT?tagChange(otag,text,i)?(--i,addBuf(),state=IN_TAG_TYPE):text.charAt(i)=="\n"?filterLine(seenTag):buf+=text.charAt(i):state==IN_TAG_TYPE?(i+=otag.length-1,tag=tagTypes[text.charAt(i+1)],tagType=tag?text.charAt(i+1):"_v",tagType=="="?(i=changeDelimiters(text,i),state=IN_TEXT):(tag&&i++,state=IN_TAG),seenTag=i):tagChange(ctag,text,i)?(tokens.push({tag:tagType,n:trim(buf),otag:otag,ctag:ctag,i:tagType=="/"?seenTag-ctag.length:i+otag.length}),buf="",i+=ctag.length-1,state=IN_TEXT,tagType=="{"&&(ctag=="}}"?i++:cleanTripleStache(tokens[tokens.length-1]))):buf+=text.charAt(i);return filterLine(seenTag,!0),tokens},Hogan.generate=function(tree,text,options){var code='var _=this;_.b(i=i||"");'+walk(tree)+"return _.fl();";return options.asString?"function(c,p,i){"+code+";}":new Hogan.Template(new Function("c","p","i",code),text,Hogan,options)},Hogan.parse=function(tokens,text,options){return options=options||{},buildTree(tokens,"",[],options.sectionTags||[])},Hogan.cache={},Hogan.compile=function(text,options){options=options||{};var key=text+"||"+!!options.asString,t=this.cache[key];return t?t:(t=this.generate(this.parse(this.scan(text,options.delimiters),text,options),text,options),this.cache[key]=t)}})