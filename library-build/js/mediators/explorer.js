define(["jquery","google/maps","data/messier","modules/mediator","util/gm-label-marker","modules/map-chooser","modules/build-control","modules/fullscreen-control"],function($,gm,messier,mediator,MarkerWithLabel,MapChooser,BuildControl,FullscreenControl){function limitBounds(map,bounds){function centerChanged(){b=map.getBounds();if(bounds.contains(ne=b.getNorthEast())&&bounds.contains(sw=b.getSouthWest())&&ne.lng()>sw.lng()){lastValidCenter=map.getCenter();return}map.panTo(lastValidCenter)}new gm.Rectangle({bounds:bounds,strokeColor:"red",strokeWeight:2,map:map});var lastValidCenter=map.getCenter(),b,ne,sw;gm.event.addListener(map,"center_changed",centerChanged),gm.event.addListener(map,"zoom_changed",function(){gm.event.addListenerOnce(map,"idle",function(){var c=map.getCenter();b=map.getBounds().toSpan(),console.log(b.toString());var n=Math.max(c.lat()+b.lat()/2-bounds.getNorthEast().lat(),0),s=Math.min(c.lat()-b.lat()/2-bounds.getSouthWest().lat(),0),e=Math.max(c.lng()+b.lng()/2-bounds.getNorthEast().lng(),0),w=Math.min(c.lng()-b.lng()/2-bounds.getSouthWest().lng(),0);console.log(c.lat(),c.lng(),b.lat(),b.lng()),console.log(bounds.getNorthEast().lng(),bounds.getSouthWest().lng()),lastValidCenter=new gm.LatLng(c.lat()-n-s,c.lng()-e-w),console.log(n,e,s,w),map.panTo(lastValidCenter)})})}function initMapTypes(map){function numberPad(num,size){var s=num+"";while(s.length<size)s="0"+s;return s}function getNormalizedCoord(coord,zoom){var y=coord.y,x=coord.x,tileRange=1<<zoom;return y<0||y>=tileRange>>1?null:x<0||x>=tileRange?null:{x:x,y:y}}var typeList=[{id:"geo",name:"Geography",tilesDir:"tiles1/"},{id:"infra",name:"Infrared",tilesDir:"tiles2/"},{id:"mic",name:"Microwave",tilesDir:"tiles3/"}];map.setOptions({mapTypeControlOptions:{style:gm.MapTypeControlStyle.HORIZONTAL_BAR,mapTypeIds:$.map(typeList,function(el){return el.id})}});for(var i=0,l=typeList.length;i<l;i++)!function(mapType){map.mapTypes.set(mapType.id,new gm.ImageMapType({getTileUrl:function(coord,zoom){var normalizedCoord=getNormalizedCoord(coord,zoom);if(!normalizedCoord)return null;var bound=Math.pow(2,zoom-1);return"http://data.bigbangregistry.com/panojs3/"+mapType.tilesDir+"tile__"+numberPad(5-zoom,3)+"_"+numberPad(normalizedCoord.x,3)+"_"+numberPad(normalizedCoord.y,3)+".jpg"},tileSize:new gm.Size(256,256),maxZoom:5,minZoom:1,name:mapType.name}))}(typeList[i]);map.setMapTypeId(typeList[0].id),mediator.publish("/explorer/map/types/ready",map,typeList)}function initMessierMarkers(map){var i,l=messier.length,m,entry,pos,proj=map.getProjection();if(!proj){gm.event.addListenerOnce(map,"projection_changed",function(){initMessierMarkers(map)});return}for(i=0;i<l;i++)entry=messier[i],pos=proj.fromPointToLatLng(new gm.Point(entry.x,entry.y),!0),m=new MarkerWithLabel({position:pos,title:entry.name,icon:icons.messier,shape:{coords:[0,0,0],type:"circle"},draggable:!1,raiseOnDrag:!1,labelContent:entry.name,labelAnchor:new google.maps.Point(22,0),labelClass:"messier-label"}),m.setMap(map),gm.event.clearListeners(m.label.eventDiv_)}function initBuildControl(map){var drawingManager=new gm.drawing.DrawingManager({drawingControl:!1,drawingControlOptions:{position:gm.ControlPosition.BOTTOM_LEFT,drawingModes:[gm.drawing.OverlayType.MARKER]},markerOptions:{icon:new gm.MarkerImage(icons.user),animation:gm.Animation.DROP}}),bc=BuildControl({mediator:mediator});drawingManager.setMap(map),mediator.subscribe("/build-control/toggle",function(active){var mode=active?gm.drawing.OverlayType.MARKER:null;drawingManager.setDrawingMode(mode)}),map.controls[gm.ControlPosition.BOTTOM_LEFT].push(bc.getEl()),gm.event.addListener(drawingManager,"overlaycomplete",function(event){var infowindow=new gm.InfoWindow({content:'Amazing - You just built a new home!<br/><br/>How about giving it a name?<br/><input type="text" placeholder="Awesome name here..." class="new-home-name"/><br/><button class="new-home-btn">Name This Feature!</button>(small donation requested)'});infowindow.open(map,event.overlay),gm.event.addListenerOnce(infowindow,"closeclick",function(){event.overlay.setMap(null)})})}function initMapChooser(map,typeList){var el,mc=MapChooser({mediator:mediator,layout:{maps:typeList}});mediator.subscribe("/map-chooser/chosen",function(id){map.setMapTypeId(id)}),el=mc.getEl(),el.index=1,map.controls[gm.ControlPosition.LEFT_CENTER].push(el)}function initFullscreenControl(map){var el,wrap=$("body"),fc=FullscreenControl({mediator:mediator});mediator.subscribe("/fullscreen-control/toggle",function(active){wrap.toggleClass("fullscreen",active),gm.event.trigger(map,"resize")}),el=fc.getEl(),map.controls[gm.ControlPosition.TOP_RIGHT].push(el)}var mapId="explorer",placeMarker=!0,icons={messier:"http://www.bigbangregistry.com/panojs3/images/dot_blue_20px.png",user:"http://www.bigbangregistry.com/panojs3/images/dot_brown_20px.png"},mapOptions={center:new gm.LatLng(77,-120),zoom:5,minZoom:2,maxZoom:5,mapTypeControl:!1,streetViewControl:!1,panControl:!1,overviewMapControl:!0,overviewMapControlOptions:{opened:!0}};mediator.subscribe("/explorer/map/projection/ready",initMessierMarkers),mediator.subscribe("/explorer/map/ready",initMapTypes),mediator.subscribe("/explorer/map/ready",initBuildControl),mediator.subscribe("/explorer/map/types/ready",initMapChooser),mediator.subscribe("/explorer/map/ready",initFullscreenControl),mediator.subscribe("/explorer/map/ready",function(map){map.getProjection()?mediator.publish("/explorer/map/projection/ready",map):gm.event.addListenerOnce(map,"projection_changed",function(){mediator.publish("/explorer/map/projection/ready",map)})}),$(function(){var el=document.getElementById(mapId),map=new gm.Map(el,mapOptions);map.controls[gm.ControlPosition.TOP_LEFT].push($('<div id="map-frame"><div class="top"></div><div class="right"></div><div class="bottom"></div><div class="left"></div></div>')[0]),mediator.publish("/explorer/map/ready",map)})})