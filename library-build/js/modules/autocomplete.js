/**
 * Autocomplete Module
 *
 * Copyright 2012, Jasper Palfree
 * Licensed under the MIT or GPL Version 2 licenses.
 */

define(["jquery","plugins/tpl!templates/autocomplete.tpl","modules/caret.jquery"],function($,template){function selRange(start,end,field){var newend,selRange;field.createTextRange?(newend=end-start,selRange=field.createTextRange(),selRange.collapse(!0),selRange.moveStart("character",start),selRange.moveEnd("character",newend),selRange.select()):field.setSelectionRange&&field.setSelectionRange(start,end)}function getWordPosAt(val,pos){var wordStart=pos,wordEnd=pos;while(wordStart>0&&val[wordStart-1]!=" ")wordStart--;while(wordEnd<val.length&&val[wordEnd]!=" ")wordEnd++;return{start:wordStart,end:wordEnd}}function AutoCompleter(config){this.setOptions(config),this.init()}function factory(config){return new AutoCompleter(config)}return AutoCompleter.prototype={classNames:{input:"autocomplete-input-box",selected:"on"},init:function(){this.cache={},this.to={},this.blacklist=[],this.queryData={},this.el=$(this.config.el).first();if(!this.el.length)return;this.el.attr("autocomplete","off").addClass(this.classNames.input),this.url=this.el.attr("data-autocomplete-url"),this.elResults=$('<div class="'+this.config.resultsClassName+'">').css({position:"absolute",display:"none"}),this.wrapper.append(this.elResults),this.enableMouseEvents(),this.bindEvents()},setOptions:function(config){this.config=$.extend(this.config||{el:null,submit:$.noop,minQueryLength:0,delay:400,align:"left",wrapper:"body",resultsClassName:"autocomplete-results",submitOnSelect:!0,usePartialComplete:!0,hintOnFocus:!0,useBlacklist:!0,itemClassName:"item",show:function(){$(this).show()},hide:function(){$(this).hide()},fetch:null},config),this.wrapper=$(this.config.wrapper)},positionResults:function(){var par=this.wrapper.offset(),offset=this.el.offset(),align=this.config.align;this.elResults.css({left:"",right:""}).css("top",offset.top-par.top+this.el.outerHeight()).css(align,align==="left"?offset[align]-par.left:this.wrapper.width()-par.left-offset.left-this.el.outerWidth())},bindEvents:function(){var self=this;this.el.on({blur:function(){self.el.one({focus:function(e){var me=this,len;setTimeout(function(){len=me.value.length,self.machineSelect=!0,selRange(len-1,len-1,self.el[0]),selRange(len,len,self.el[0]),self.machineSelect=!1,self.activate(!0)},100)}})}}).trigger("blur"),this.el.on({select:function(e){self.to.activate&&!self.machineSelect&&(clearTimeout(self.to.activate),self.deactivate())},mouseup:function(e){self.el.val().length>0&&(self.doSelect=!0,self.activate(20))},touchend:function(e){self.el.val().length>0&&(self.doSelect=!0,self.activate(20))},keydown:function(e){self.lastKeyPressed=e.keyCode,self.doSelect=!1;switch(self.lastKeyPressed){case 38:self.active?self.focusPrev():self.activate(!0);break;case 40:self.active?self.focusNext():self.activate(!0);break;case 9:if(!self.active)return!0;self.selectCurrent(!0);break;case 13:self.active?self.selectCurrent(!self.config.submitOnSelect):self.submit();break;case 27:if(!self.active)return!0;self.el.val(self.getSuggestQuery().oldText),self.deactivate();break;default:return self.activate(),!0}return e.preventDefault(),!1}}),this.elResults.on({mouseenter:function(e){if(self.noMouse)return;if(self.disableMouseEnter){self.disableMouseEnter--;return}self.focusItem(this)},click:function(e){e.preventDefault();if(self.noMouse)return;self.focusItem(this),self.selectCurrent(!self.config.submitOnSelect),self.el.focus(),self.disableMouseEnter=1}},"."+this.config.itemClassName),$(document).on("click",function(e){var el=e.target;!self.elResults.is(el)&&!self.el.is(el)&&!self.elResults.has(el).length&&self.deactivate()})},selectSuggestQuery:function(){var self=this,data=self.getSuggestQuery();self.machineSelect=!0,selRange(data.start,data.start+1,this.el[0]),setTimeout(function(){selRange(data.start,data.end,self.el[0]),self.machineSelect=!1},10)},getSuggestQuery:function(refresh){if(!refresh)return this.queryData;var startPos=this.el.caret().start,val,pos;return this.queryData.oldText=this.el.val(),val=this.queryData.oldText.replace(/\s+$/,""),!this.config.usePartialComplete||startPos>=val.length?(this.queryData.start=0,this.queryData.end=this.queryData.oldText.length,this.queryData.query=val):(pos=getWordPosAt(val,startPos),this.queryData.start=pos.start,this.queryData.end=pos.end,this.queryData.query=val.substring(pos.start,pos.end)),this.queryData},activate:function(noTimeout){function callback(){var value=self.getSuggestQuery(!0).query;self.focusedItem=-1,value.length>self.config.minQueryLength&&self.fetchResults(value,function(results){results&&self.showResults(results,value)})}var self=this;self.to.activate&&clearTimeout(self.to.activate),self.ajaxRequest&&self.ajaxRequest.abort(),noTimeout===!0?callback():self.to.activate=setTimeout(callback,noTimeout||self.config.delay)},deactivate:function(){this.focusedItem=null,this.hideResults()},fetchResults:function(value,callback){var self=this,content=self.cache[value];if(content)callback(content);else{if(self.isBlacklisted(value)){self.deactivate();return}if(this.config.fetch){this.config.fetch(value,function(data){content=data,self.cache[value]=content,callback(content)});return}self.ajaxRequest=$.ajax({url:self.url+(self.url.indexOf("?")!==-1?"&":"?")+encodeURIComponent(self.el.attr("name"))+"="+encodeURIComponent(value),dataType:"json",success:function(data){content=data,self.cache[value]=content,callback(content)},error:function(){callback(!1)}})}},isBlacklisted:function(query){if(this.config.useBlacklist===!1)return!1;for(var i in this.blacklist)if(query.indexOf(this.blacklist[i])===0)return!0;return!1},showResults:function(results,query){var self=this;self.elResults.html(template.render(results));if(results&&self.elResults.find("."+self.config.itemClassName).length===0){self.config.useBlacklist&&self.blacklist.push(query),self.deactivate();return}self.positionResults(),self.doSelect&&query!==self.el.val().replace(/\s+$/,"")&&self.selectSuggestQuery(),self.config.show.apply(self.elResults[0]),self.active=!0},hideResults:function(){var self=this;self.config.hide.apply(self.elResults[0]),self.active=!1},submit:function(){this.config.submit.apply(this.el[0])},focusNext:function(){this.focusItem(this.focusedItem+1)},focusPrev:function(){this.focusItem(this.focusedItem-1)},focusItem:function(n){var $items=this.elResults.find("."+this.config.itemClassName),$item;typeof n=="number"?(n<0?n=0:n>=$items.length&&(n=$items.length-1),$item=$items.eq(n)):$item=$(n),$items.removeClass(this.classNames.selected),$item.addClass(this.classNames.selected),this.focusedItem=$item.index(),this.config.hintOnFocus&&this.hintSuggestion()},hintSuggestion:function(){var $item,sug,len,qd=this.getSuggestQuery(),val="",i=0;if(this.focusedItem>=0){$item=this.elResults.find("."+this.config.itemClassName+":eq("+this.focusedItem+")"),sug=$item.find(".sug"),val=sug.length?sug.text():$item.text(),len=val.length,this.el.val(qd.oldText.replace(qd.query,val));while(i<val.length&&qd.query[i]===val[i])i++;this.machineSelect=!0,selRange(qd.start+i,qd.start+len,this.el[0]),this.machineSelect=!1}},selectCurrent:function(preventSubmit){var $item,sug,qd=this.getSuggestQuery(),val="";if(this.focusedItem>=0){$item=this.elResults.find("."+this.config.itemClassName+":eq("+this.focusedItem+")"),sug=$item.find(".sug"),val=sug.length?sug.text():$item.text(),val=qd.oldText.replace(qd.query,val).replace(/\s+$/,""),val+=preventSubmit?" ":"",this.el.val(val),this.el.focus();if(preventSubmit){this.activate(!0);return}}this.deactivate(),this.submit()},disableMouseEvents:function(){this.noMouse=!0},enableMouseEvents:function(){this.noMouse=!1}},factory})