define(["require","stapes"],function(require,Stapes){var model=Stapes.create().extend({options:{url:null,fetch:!0,filter:null,idKey:"id"},init:function(opts){return this.extend(this.options,opts),this.options.fetch&&this.options.url&&this.fetch(),this.emit("ready"),this},fetch:function(url,retryDelay){var self=this;return url=url||self.options.url,require(["plugins/json!"+url],function(data){self.options.filter&&(data=self.options.filter(data)),self.add(data),self.emit("fetch")},function(){retryTimeout=~~retryTimeout+1,setTimeout(function(){self.fetch(url,retryTimeout)},Math.pow(2,retryTimeout)*1e3)}),this},find:function(prop,val,fuzzy){var self=this,reg,v,fn;return Stapes.util.typeOf(prop)==="function"?fn=prop:fuzzy?(reg=new RegExp(val,"i"),fn=function(item){return v=item[prop],v.match&&v.match(reg)}):fn=function(item){return item[prop]===val},this.filter(fn)},add:function(data){var self=this,id=self.options.idKey;switch(Stapes.util.typeOf(data)){case"object":self.set(data);break;case"array":Stapes.util.typeOf(data[0])==="object"&&Stapes.util.typeOf(data[0][id])!=="undefined"?Stapes.util.each(data,function(val){self.set(val[id],val)}):self.push(data);break;default:self.push(data)}return this},flush:function(){return this.remove(function(){return!0}),this}});return{init:function(opts){return model.create().init(opts)}}})